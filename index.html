<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<script src="./jquery-1.9.1.js"></script>
	<script src="./d3/d3.min.js"></script>
	<script src="./topojson/topojson.js"></script>
    <script type="text/javascript" src="./dist-db.js"></script>
    <script type="text/javascript" src="./utils/Palette.js"></script>

	<style type="text/css">
	/*
		div, span .label {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
		}
		span .dateRange {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
			background-color:#b4cdcd;
		}
		table {
	  		table-layout: fixed;
	  		border-collapse: collapse;
	  		width: 100%;
		}

		table td, th {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
		}

		table td.dateCol, table th.dateCol {
    		width: 100px;
		}

		table td.placeCol, table th.placeCol {
    		width: 100px;
		}

		table td.descCol, table th.descCol {
    		width: 500px;
		}
*/
        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

		.brush .extent {
  			stroke: #fff;
  			fill-opacity: .125;
  			shape-rendering: crispEdges;
		}

        .selectBox {
        	fill: none;
        	stroke: black;
            shape-rendering: crispEdges;
        }

      	.tick line {
    		stroke: lightgrey;
    		opacity: 0.7;
    		stroke-width: 1;
		}

		.subunit {
 			fill: none;
  		 	stroke: #777;
  			//stroke-dasharray: 2,2;
  			stroke-linejoin: round;
		}

		.admin1subunit {
 			fill: none;
    		opacity: 0.7;
  		 	//stroke: #777;
  			//stroke-dasharray: 2,2;
  			//stroke-linejoin: round;
		}

		.urban-area {
 			fill: #C4C2C3;
  		 	//stroke: #777;
  			//stroke-dasharray: 2,2;
  			//stroke-linejoin: round;
		}

		.urban-area-boundary {
 			fill: #C4C2C3;
  		 	//stroke: #777;
  			//stroke-dasharray: 2,2;
  			//stroke-linejoin: round;
		}

		circle {
			opacity: 0.8;
		}

//.subunit.NGA { fill: #FFFAFA; }

.subunit-boundary {
  fill: none;
  stroke: #777;
  stroke-dasharray: 2,2;
  stroke-linejoin: round;
}

.admin1-boundary {
  fill: none;
  stroke: #999;
  stroke-dasharray: 2,2,1,3,4;
  stroke-linejoin: round;
}


.subunit-label {
  fill: #777;
  fill-opacity: .5;
  font-size: 20px;
  font-weight: 300;
  text-anchor: middle;
}

.river {
	fill: none;
	stroke: #6978D1;
}

.place,
.place-label {
  fill: #444;
}

text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 10px;
  pointer-events: none;
}

.background {
  pointer-events: all;
  fill: none;	
}

#circleGroup {
  pointer-events: all;
  fill: none;
}


	</style>

	<link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">


</head>
<body>

<div class="container">
<div class="row">

	<div class="span3">

		<form id="queryForm"> 
			<span>
				<div>
					<span class="label">Incident Type:</span><br/>
					<div id="selectIncidentType">
					</div>
					<!-- <select id="selectIncidentType" multiple="yes"></select> -->
				</div>

				<div>
					<span class="label">Description:</span><br/>
					<input type="text" id="inputDescription">
				</div>
			</span>

		</form>	

	</div>

	<div class="span9">

		<ul class="nav nav-tabs">
			<li><a href="#timelines" data-toggle="tab">Timelines</a></li>
			<li class="active"><a href="#map" data-toggle="tab">Map</a></li>
			<li><a href="#country-selector" data-toggle="tab">Select Country</a></li>
		</ul>
		<div id="dateSelector"></div>

		<div class="tab-content">
			
<!-- why do I have the inner divs here??? -->

			<div class="tab-pane" id="timelines">
		  		<div id="dataTable"></div>
			</div>
		  	
		  	<div class="tab-pane active" id="map">
		  		<div id="mapTable"></div>
		  		<br/>
		  	</div>

			<div class="tab-pane" id="country-selector">
		  		<div id="countrySelector">
		  		</div>
			</div>
		
		</div>

	</div>

</div>
</div>

		<script type="text/javascript">

var dataset = false,
	chart = false,
	svgMap = false, 
	brush = false,
	context = false,
	jsonReady = false
	mapContainer = false;

var mapWidth = 700,
	mapHeight = 420;

p = new Palette();

dimensions = { width: 700, height: 40 };  //height=40 was for rendering each separately
padding    = { outerPaddingWidth: 5, placenameWidth: 70, innerPaddingWidth: 5,
   outerPaddingHeight: 2, labelHeight: 10, tickToLabelHeight: 3, tickHeight: 5, 
   axisToIncidentsHeight: 5 };
corners    = { xTimelineLeft: padding.outerPaddingWidth + padding.placenameWidth + padding.innerPaddingWidth,
   xTimelineRight: dimensions.width - padding.outerPaddingWidth,
   yTimelineTop: padding.outerPaddingHeight,
   yTimelineBottom: dimensions.height - (padding.outerPaddingHeight + padding.labelHeight + padding.tickToLabelHeight + padding.tickHeight) };

dateFormat = d3.time.format("%x");

loadNewCountry("Nigeria");

function loadNewCountry(country) {

console.log("loadNewCountry");
	
	//$('*').unbind();

	if(!context) makeCountryList();

	if(context) context.remove();
	if(mapContainer) mapContainer.remove();
	//if(svgMap) svgMap.remove();
	if(chart) chart.remove();

	cachedResultArr = undefined;
	
	loadDataset(country);
}

/*
function removeChildren(node) {
	while (node.hasChildNodes()) {
	    node.removeChild(node.lastChild);
	}
}
*/

function loadDataset(country) {

	var jsonArray;

	if(jsonReady) {
		$(window).unbind('JSONready');
	}

	$.getJSON('data/' + country + '.json', function(response) {

		/* hacky way to jitter the points because too much overlap due to imprecise coordinates */
		var lonJitterBase = 0.01 * mapWidth, //(boundingBox.east - boundingBox.west),
			latJitterBase = 0.01 * mapHeight;
		for(var i = 0, n = response.length; i < n; i++) {
				response[i].LATITUDE_JITTER = (Math.random() - 0.5) * latJitterBase;
				response[i].LONGITUDE_JITTER = (Math.random() - 0.5) * lonJitterBase;
		}

   		jsonArray = response;
   		$(window).trigger('JSONready');
	});

	jsonReady = $(window).on('JSONready', function() {

		dataset = new db.Collection();

		dataset.loadData(

		  jsonArray,

			  { FATALITIES:  		{ index: db.NumberIndex },
			    COUNTRY:     		{ index: db.CategoryIndex },
			    ADM_LEVEL_1_BY_COUNTRY: { index: db.CategoryIndex,
			    					  	  opts: { keyExtractor: function(o) { return o.COUNTRY + '|' + o.ADM_LEVEL_1; }}}, 
			    EVENT_DATE:  		{ index: db.DateIndex }, 
			    EVENT_TYPE:  		{ index: db.CategoryIndex },
			    CONSOLIDATED_NOTES: { index: db.TextIndex }});

		//CREATE QUERYTEMPLATE

		ps = new db.QueryTemplate(

			dataset, 

			db.qtIntersect(
				db.qtField("EVENT_TYPE"), 
				//db.qtField("COUNTRY"),
				db.qtField("EVENT_DATE"),
				db.qtField("NOTES")),

			function(resultArr) { 
				renderResults("dataTable", resultArr);
			});
	
		createInterface();
		drawMap(country);

	});
}

function newTextInput(inputObj, preparedStmt, label) {
	if(inputObj.value === "") {
		preparedStmt.evaluate(label, {selectAll: true});	
	} else {
		preparedStmt.evaluate(label, {autoCompleteSearch: inputObj.value});
	}
}

function newMultiSelect(selectObj, preparedStmt, label) {
	//selectObj.children[0].children[0].checked
	/*
		while (node.hasChildNodes()) {
	    	node.removeChild(node.lastChild);
		}
	*/
	var options = [];
	var child = selectObj.firstChild;
	while(child) {
    	if(child.children[0].checked) {
    		options.push(child.children[0].getAttribute("data-value"));
    	}
    	
    	child = child.nextSibling;
	}
	/*
	for (var i = 0, n = selectObj.length; i < n; i++) {
        if (selectObj[i].selected) {
			var which = selectObj.options[i].value;
			options.push(which);
		}
	}
	*/

	if(options.length === 0) {
		preparedStmt.evaluate(label, {selectAll: true});	
	} else {
		preparedStmt.evaluate(label, {any: options});
	}
}

function brushed() {

	var ext = brush.extent();

	//made at least temporarily global so can use in renderResults
	startDate = ext[0].getTime(); 
	endDate = ext[1].getTime();
	ps.evaluate("EVENT_DATE", {inRange: [dateFormat(ext[0]), dateFormat(ext[1])]});
}

function createInterface() {

	function fillSelect(idName,fieldName) {
		var s = document.getElementById(idName);
		var opts = dataset.indexRegistry[fieldName].getValues().sort();
		var htmlStr = "";
		for(var i = 0; i < opts.length; i++) {
			if(opts[i] !== "-9") {  //total special case
				//s.options[s.options.length] = new Option(opts[i], opts[i]);
				htmlStr += '<label class="checkbox">'
							+ '<input type="checkbox" data-value="' + opts[i] + '">'
							+ opts[i]
							+ '</label>';
			}
		}
		document.getElementById(idName).innerHTML = htmlStr;
	}

	fillSelect("selectIncidentType", "EVENT_TYPE");
	//fillSelect("selectPlaceName", "COUNTRY");

/*
	xScale = (function() {
		return d3.time.scale()
	            .domain([dateFormat.parse("1/1/1997").getTime(), dateFormat.parse("2/28/2013").getTime()])
	            //.range([corners.xTimelineLeft - padding.placenameWidth, 545 - 10 - corners.xTimelineLeft - padding.placenameWidth])
	            .range([corners.xTimelineLeft - padding.placenameWidth, corners.xTimelineRight - padding.placenameWidth - padding.placenameWidth])
	            .clamp(true);
		})();
*/
	var selectorScale = d3.time.scale().range([corners.xTimelineLeft - padding.placenameWidth, corners.xTimelineRight - padding.placenameWidth -  padding.placenameWidth]),
		selectorAxis = d3.svg.axis().scale(selectorScale).orient("bottom");
	selectorScale.domain([dateFormat.parse("1/1/1997"), dateFormat.parse("2/28/2013")]);

	brush = d3.svg.brush()
			  .x(selectorScale)
			  .extent([dateFormat.parse("1/1/2004"), dateFormat.parse("1/1/2005")]);


	context = d3.select("#dateSelector").append("svg")
		.attr("width", dimensions.width)
		.attr("height", 40);

	context.append("rect")
		  .classed("selectBox", true)
	      .attr("x", corners.xTimelineLeft - padding.placenameWidth)
	      .attr("width", corners.xTimelineRight - corners.xTimelineLeft - padding.placenameWidth)
	      .attr("y", 0) 
	      .attr("height", 20);
	     
	context.append("g")
	      .attr("class", "axis")
	      .attr("transform", "translate(0," + 20 + ")")
	      .style("font-size", padding.labelHeight)
	      .style("font-family", "sans-serif")
	      //.attr("transform", "translate(0," + (maxOffset + dimensions.height + 10 + 35) + ")")
	      .call(selectorAxis);

	context.append("g")
	      .attr("class", "x brush")
	      .call(brush)
	    .selectAll("rect")
	      .attr("y", 1)
	      .attr("height", 18);
}

function enableEventHandlers() {

	document.getElementById("selectIncidentType")
		.addEventListener("change", function() { newMultiSelect(this,ps,"EVENT_TYPE"); });

	//document.getElementById("selectPlaceName")
	//	.addEventListener("change", function() { newMultiSelect(this,ps,"COUNTRY"); });

	document.getElementById("inputDescription")
		.addEventListener("keyup", function() { newTextInput(this,ps,"CONSOLIDATED_NOTES"); });

	brush.on("brush", brushed);
}

function drawTimelines() {

	xScale = (function() {
		return d3.time.scale()
					  .domain([dateFormat.parse("1/1/1997").getTime(), 
	            		 dateFormat.parse("2/28/2013").getTime()])
	            .range([corners.xTimelineLeft, corners.xTimelineRight])
	            .clamp(true);
		})();


	//var cnames = dataset.indexRegistry.COUNTRY.getValues().sort();
	var cnames = dataset.indexRegistry
						.ADM_LEVEL_1_BY_COUNTRY.getValues()
						.sort();
	countryOffsets = {};
	for(var i = 0, n = cnames.length; i < n; i++) {
		countryOffsets[cnames[i]] = 20 + i * dimensions.height;

	}
	var maxOffset = 20 + i * dimensions.height;

	totalHeight = maxOffset + 20 - 10;

	chart = d3.select("#dataTable").append("svg")
		.attr("class", "chart")
		.attr("width", 555) //dimensions.width)
		.attr("height", totalHeight);

	var splitCnames = cnames.map(function(s) { return s.split('|'); });

	for(var i = 0, n = cnames.length; i < n; i++) {
		chart.append("text")
		   .text(splitCnames[i][1])
		   .attr("x", padding.outerPaddingWidth)
		   .attr("y", 20 + i * dimensions.height + (dimensions.height / 3))
           .attr("font-size", dimensions.height / 4)
           .attr("font-family", "sans-serif")
           .attr("font-weight", "bold");
		chart.append("text")
		   .text(splitCnames[i][0])
		   .attr("x", padding.outerPaddingWidth)
		   .attr("y", 20 + i * dimensions.height + 2 * (dimensions.height / 3))
           .attr("font-size", dimensions.height / 4)
           .attr("font-family", "sans-serif");
    }

	tl = chart.append("g")
	     .attr("class", "axis")
	     .attr("transform", "translate(0,15)") //+ (maxOffset + corners.yTimelineBottom) + ")")
         .style("font-size", padding.labelHeight)
         .style("font-family", "sans-serif");

	//tl.select("g")
        tl.call(d3.svg.axis()
          .scale(xScale)
          .tickFormat(d3.time.format("%b %Y"))
          .ticks(5)
          .orient("top")
          .tickSize(-10) //(-totalHeight)
          //.tickSize(padding.tickHeight)
          .tickPadding(padding.tickToLabelHeight));
}

function drawMap(country) {

	


	mapContainer = 
		d3.select("#mapTable").append("svg")
	      .attr("width", mapWidth)
	      .attr("height", mapHeight)
	      .attr("id", "mapTableSvg");

	  mapContainer.append("defs").append("clipPath")
	      .attr("id", "mapClip")
	    .append("rect")
	      .attr("width", mapWidth)
	      .attr("height", mapHeight);

	   svgMap = mapContainer.append("g")
	      .attr("clip-path", "url(#mapClip)");

	//with considerable debt to http://bost.ocks.org/mike/map/
	if(country === "Democratic_Republic_of_the_Congo") {
		var filename = "Congo.json"; 
	} else if(country === "Republic_of_Congo") {
		var filename = "Republic_of_the_Congo.json";
	} else {
		var filename = country + ".json"; 
	}
	d3.json("maps/bounding_boxes.json", function(error, boundingBoxes) {

		if(country === "Democratic_Republic_of_the_Congo") {
			var lookupVal = "Congo"; 
		} else if(country === "Republic_of_Congo") {
			var lookupVal = "Republic_of_the_Congo";
		} else {
			var lookupVal = country; 
		}

		var boundingBox = boundingBoxes.filter(function(o) { return o.countryName === lookupVal.replace(/_/g,' '); })[0];

		d3.json("maps/" + filename, function(error, nigeria) {

		 	var subunits = topojson.object(nigeria, nigeria.objects.subunits),
		 	  admin1 = topojson.object(nigeria, nigeria.objects.admin1),
		      places = topojson.object(nigeria, nigeria.objects.places),
		      rivers = topojson.object(nigeria, nigeria.objects.rivers),
		      urbanAreas = topojson.object(nigeria, nigeria.objects.urban);

		      //see http://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object

		      var scale  = 45 * mapWidth / (boundingBox.east - boundingBox.west);
		      var offset  = [mapWidth / 2 - 65, mapHeight / 2];
		      var center = [ boundingBox.west + (boundingBox.east - boundingBox.west)/2, boundingBox.south + (boundingBox.north - boundingBox.south)/2];

		      // new projection
		      //projection = d3.geo.mercator().scale(scale);
		      projection = d3.geo.mercator() //.center(center)
		        .scale(scale).center(center).translate(offset);
		        //.precision(.1);

		var path = d3.geo.path()
		    .projection(projection)
		    .pointRadius(2);

		svgMap.append("rect")
	    	.attr("class", "background")
	    	.attr("width", mapWidth)
	    	.attr("height", mapHeight);
	    	//.on("mouseup", zoom);

		  svgMap.selectAll(".subunit")
		      .data(subunits.geometries)
		    .enter().append("path")
		      .attr("class", function(d) { return "subunit " + d.id; })
		      .attr("d", path);

		  svgMap.selectAll(".river")
		      .data(rivers.geometries)
		    .enter().append("path")
		      .attr("class", "river")
		      .attr("style", function(d) { return "stroke-width:" + (d.properties.strokeweig * 2.5);})
		      .attr("d", path);

		  svgMap.selectAll(".urbanArea")
		      .data(urbanAreas.geometries)
		    .enter().append("path")
		      .attr("class", "urban-area")
		      //.attr("style", function(d) { return "stroke-width:" + (d.properties.strokeweig * 2);})
		      .attr("d", path);

		  //is this part necessary?
		  svgMap.append("path")
		      .datum(topojson.mesh(nigeria, nigeria.objects.urban, function(a, b) { return a !== b; }))
		      .attr("d", path)
		      .attr("class", "urban-area-boundary");

		  svgMap.append("path")
		      .datum(topojson.mesh(nigeria, nigeria.objects.subunits, function(a, b) { return a !== b; }))
		      .attr("d", path)
		      .attr("class", "subunit-boundary");

		  svgMap.selectAll(".admin1subunit")
		      .data(admin1.geometries)
		    .enter().append("path")
		      .attr("class", function(d) { return "admin1subunit " + d.id; })
		      .attr("d", path);

		  svgMap.append("path")
		      .datum(topojson.mesh(nigeria, nigeria.objects.admin1, function(a, b) { return a !== b; }))
		      .attr("d", path)
		      .attr("class", "admin1-boundary");

		  svgMap.append("path")
		      .datum(places)
		      .attr("d", path)
		      .attr("class", "place");

		  svgMap.selectAll(".place-label")
		      .data(places.geometries)
		    .enter().append("text")
		      .attr("class", "place-label")
		      .attr("transform", function(d) { return "translate(" + projection(d.coordinates) + ")"; })
		      .attr("x", function(d) { return d.coordinates[0] > -1 ? 6 : -6; })
		      .attr("dy", ".35em")
		      .style("text-anchor", function(d) { return d.coordinates[0] > -1 ? "start" : "end"; })
		      .text(function(d) { return d.properties.name; });

	mapContainer.append("g")
		.attr("id", "circleGroup");
	//.on("mouseup", showTooltip);

/*
data-toggle="tooltip" title="first tooltip"
*/
	drawTimelines();
	enableEventHandlers();
	intializeControls();

	    //svgMap.call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom));
		/* svgMap.call(d3.behavior.zoom()
	      	  .translate(projection.translate())
	      	  .scale(projection.scale())
	      	  .on("zoom", redrawForZoom));
	    */
		});
	});
}

function showTooltip() {
	var mouseTarget = event.target;
	var targetId = mouseTarget.getAttributeNS(null, "id");
	mouseTarget.setAttributeNS(null, "title", "A title.");
	//$('#' + targetId).tooltip({title: "A title."});
	$('#' + targetId).tooltip('show');
	console.log(targetId);
}

/*
function zoom() {
	var mapWidth = 700,
	    mapHeight = 420;
	var k = 3;
	var xOffset = mapWidth / k / 2, 
		yOffset = mapHeight / k / 2;
	var x, y;
	if(event.offsetX - xOffset < 0) {
		x = 0;
	} else if(event.offsetX + xOffset > mapWidth) { 
		x = event.offsetX - (xOffset + xOffset - mapWidth - event.offsetX);
	} else {
		x = event.offsetX - xOffset;
	}
	if(event.offsetY - yOffset < 0) {
		y = 0;
	} else if(event.offsetY + yOffset > mapHeight) {
		y = event.offsetY - (yOffset + yOffset - mapHeight - event.offsetY);
	} else {
		y = event.offsetY - yOffset;
	}
	
	svgMap.selectAll("path")
	  .attr("transform", "scale(" + k + ") translate(" + -x + "," + -y + ")");
	  //.style("stroke-width", 1.5 / k + "px");
	svgMap.selectAll("circle")
	  .attr("transform", "scale(" + k + ") translate(" + -x + "," + -y + ")")
	  //.style("stroke-width", 1.5 / k + "px");
	svgMap.selectAll("text")
	  .attr("transform", "scale(" + k + ") translate(" + -x + "," + -y + ")");
	  //.style("stroke-width", 1.5 / k + "px");

      //.classed("active", centered && function(d) { return d === centered; });
            
		//.attr("transform", "translate(" + mapWidth / 2 + "," + mapHeight / 2 + ") scale(" + k + ")")// translate(" + -x + "," + -y + ")")
      
	//svgMap.selectAll().attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}
*/
/*
function redrawForZoom() {
  if (d3.event) {
    projection
        .translate(d3.event.translate)
        .scale(d3.event.scale);
  }
  svgMap.selectAll("path")  

  //PATH ISN'T DEFINED HERE
        .attr("d", path.projection(projection)); 
}
*/

function makeCountryList() {
	
	var countryList = ["Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cameroon", 
	"Central African Republic","Chad", "Democratic Republic of the Congo", "Djibouti", "Egypt", 
	"Equatorial Guinea", "Eritrea", "Ethiopia","Gabon", "Gambia", "Ghana", "Guinea-Bissau", "Guinea", 
	"Ivory Coast", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", "Mauritania", 
	"Morocco", "Mozambique", "Namibia", "Niger", "Nigeria", "Republic of Congo", "Rwanda", 
	"Senegal", "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Spain", "Sudan", "Swaziland", 
	"Tanzania", "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe"];

	var s ="";
	countryList.forEach(function(v) { 
		s += "<div><a onclick=\"loadNewCountry('" + v.replace(/ /g, "_") + "');\">" + v + "</a></div>"; 
	});

	document.getElementById("countrySelector").innerHTML = s;
}

function intializeControls() {
	brushed();
	newMultiSelect(document.getElementById("selectIncidentType"),ps,"EVENT_TYPE");
	newTextInput(document.getElementById("inputDescription"),ps,"NOTES");
}
		
function renderResults(parentElement, resultArr) {

	cachedResultArr = typeof cachedResultArr === "undefined" ? [] : cachedResultArr;
		
	var diffs = db.sets.complements(cachedResultArr, resultArr),
		enter = diffs[0],
		exit = diffs[1];

	var svgMapNode = document.getElementById("circleGroup");
	//var svgMapNode = document.getElementById("svgMap");

	var enterFragment = document.createDocumentFragment();

	for(var i = 0, n = enter.length; i < n; i++) {
		var d = enter[i]; 
		var proj = projection([d.LONGITUDE, d.LATITUDE]);
		var circle = document.createElementNS(svgMapNode.namespaceURI, "circle");
		circle.setAttributeNS(null, "id", d.MY_EVENT_ID);
		circle.setAttributeNS(null, "cy", proj[1] + d.LATITUDE_JITTER);
		circle.setAttributeNS(null, "cx", proj[0] + d.LONGITUDE_JITTER);
		circle.setAttributeNS(null, "r", 3);
		circle.setAttributeNS(null, "fill", p.getColor(d.EVENT_TYPE));
		//circle.setAttributeNS(null, "mouseup", function() { console.log("mouseup on circle");});
		//circle.setAttributeNS(null, "data-toggle", "popover");
		//circle.setAttributeNS(null, "title", "here is a title");
		enterFragment.appendChild(circle);
	}

	/*
	  	.insert("svg:title")   //or .append?
	    	.text(function(d) { 
	        	    return d.COUNTRY + '(' + d.EVENT_DATE + '): ' + d.NOTES; 
	          	});              
	*/

	svgMapNode.appendChild(enterFragment);

//**CAN REINTRODUCE THIS: JUST REMOVE AND REINSERT THE PARENT
//**WILL DOCUMENT.GETELEMENTID WORK WHEN ITS REMOVED?
	//var insertFunction = removeToInsertLater(svgMapNode);
	for(var i =0, n = exit.length; i < n; i++) {
		var d = exit[i];
		svgMapNode.removeChild(document.getElementById(d.MY_EVENT_ID));
	}
	//insertFunction();

	//from https://developers.google.com/speed/articles/javascript-dom
	/**
	 * Remove an element and provide a function that inserts it into its original position
	 * @param element {Element} The element to be temporarily removed
	 * @return {Function} A function that inserts the element into its original position
	 **/
	function removeToInsertLater(element) {
	  var parentNode = element.parentNode;
	  var nextSibling = element.nextSibling;
	  parentNode.removeChild(element);
	  return function() {
	    if (nextSibling) {
	      parentNode.insertBefore(element, nextSibling);
	    } else {
	      parentNode.appendChild(element);
	    }
	  };
	}

	//BEGIN TIMELINES

	xScale = (function() {
		return d3.time.scale()
				.domain([startDate, endDate])
	            .range([corners.xTimelineLeft, 555])
	            .clamp(true);
		})();

    tl.call(d3.svg.axis()
      .scale(xScale)
      .tickFormat(d3.time.format("%b %Y"))
      .ticks(5)
      .orient("top")
	  .tickSize(-10) //(-totalHeight)
      //.tickSize(padding.tickHeight)
      .tickPadding(padding.tickToLabelHeight));


	var cs = chart.selectAll("circle")
	  .data(resultArr, function(d) { return d.MY_EVENT_ID; });
	cs.enter().insert("circle")
	  .attr("cx", function(d, i) { return xScale(dateFormat.parse(d.EVENT_DATE).getTime()); })
	  .attr("cy", function(d) { return countryOffsets[d.COUNTRY+'|'+d.ADM_LEVEL_1] + corners.yTimelineBottom - padding.axisToIncidentsHeight; })
	  .attr("r", 3)
	  .attr("fill", function(d) { return p.getColor(d.EVENT_TYPE); })
	  .insert("svg:title")   //or .append?
        .text(function(d) { 
                return '(' + d.EVENT_DATE + '): ' + d.CONSOLIDATED_NOTES; 
              });

    cs.attr("cx", function(d, i) { return xScale(dateFormat.parse(d.EVENT_DATE).getTime()); });  //.transition()
      

	cs.exit().remove();

//END TIMELINES

	cachedResultArr = resultArr;

}





	</script>

<!-- <script src="./bootstrap/js/bootstrap.min.js"></script> -->
<script src="./twitter-bootstrap-37d0a30/bootstrap.js"></script>
<script>
  $(function () {
    $('#m a[href="#map"]').tab('show');
  });
/* $(function () {
        $("[rel='tooltip']").tooltip();
   });
*/
</script>

</body>
</html>